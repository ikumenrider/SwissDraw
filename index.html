<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss Draw App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B0N79J2F6L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B0N79J2F6L');
</script>

    
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 relative">
        <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨è£½ä½œè€…æƒ…å ±ã‚’åŒã˜è¡Œã®å·¦å³ã«é…ç½® -->
        <div class="flex justify-between items-center mb-6">
            <div class="text-sm">
                <span class="text-gray-500 font-semibold">Version:</span>
                <span class="text-gray-700 font-bold">1.0</span>
            </div>
            <div class="text-sm">
                <span class="text-gray-500 font-semibold">è£½ä½œè€…:</span>
                <a href="https://ikumenrider.github.io/ikumenrider/" target="_blank" class="p-1 px-3 bg-gray-200 text-gray-700 rounded-lg font-bold transition-all duration-200 transform hover:scale-105 hover:bg-gray-300">
                    è‚²é¢ãƒ©ã‚¤ãƒ€ãƒ¼
                </a>
            </div>
        </div>
        
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ã‚¹ã‚¤ã‚¹ãƒ‰ãƒ­ãƒ¼ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h1>

        <!-- å‚åŠ è€…è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">å‚åŠ è€…</h2>
            <p class="text-sm text-gray-500 mb-1">å‚åŠ è€…ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„(1è¡Œã«1å)</p>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <textarea id="playerNameInput" rows="4" placeholder="é¸æ‰‹å1&#10;é¸æ‰‹å2&#10;é¸æ‰‹å3&#10;â€¦" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button onclick="addPlayers()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105">å‚åŠ è€…ã‚’è¿½åŠ </button>
            </div>
            <div id="playerList" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-gray-600">
                <!-- å‚åŠ è€…ãƒªã‚¹ãƒˆã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <div id="playerCount" class="text-left text-sm text-gray-500 mt-2">ç¾åœ¨ 0 äººãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</div>
        </div>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-wrap justify-center gap-4 mb-6">
            <button id="startRoundBtn" onclick="startNewRound()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105">ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹</button>
            <button id="resetBtn" onclick="showResetConfirmation()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <!-- ãƒ©ã‚¦ãƒ³ãƒ‰ã¨ãƒšã‚¢ãƒªãƒ³ã‚° -->
        <div id="roundsContainer" class="bg-white p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰</h2>
            <div id="currentRoundInfo" class="text-center text-gray-500 italic mb-4">ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
            <div id="pairings" class="space-y-4">
                <!-- ãƒšã‚¢ãƒªãƒ³ã‚°ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <!-- æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€/æœ€çµ‚çµæœãƒœã‚¿ãƒ³ -->
            <button id="nextRoundBtn" onclick="proceedToNextStep()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105 mt-4 w-full" style="display: none;">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€</button>
        </div>
        
        <!-- çµæœè¡¨ç¤º -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h2 id="standingsHeader" class="text-xl font-semibold text-gray-700 mb-4">é †ä½</h2>
            <div id="standings" class="space-y-2">
                <!-- é †ä½ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <!-- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçµ„ã¿ãªãŠã—ãƒœã‚¿ãƒ³ -->
            <div id="reconfigureBtnDiv" class="flex justify-center mt-4">
                <button onclick="showResetConfirmation()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçµ„ã¿ãªãŠã—</button>
            </div>
        </div>
        
        <!-- ã‚¢ãƒ—ãƒªä¸€è¦§ãƒœã‚¿ãƒ³ -->
        <div class="flex justify-center">
            <a id="btn-app-list" href="https://ikumenrider.github.io/ikumenrider/" target="_blank" class="p-3 px-5 bg-green-300 text-gray-900 font-bold rounded-xl shadow-lg hover:bg-green-400 transition-all duration-200 transform hover:scale-105">
                ã‚¢ãƒ—ãƒªä¸€è¦§
            </a>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
        <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-md shadow-lg hidden">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
        <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="resetMessage" class="text-sm text-gray-500">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="confirmResetBtn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 mb-2">
                            ãƒªã‚»ãƒƒãƒˆ
                        </button>
                        <button id="cancelResetBtn" class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let players = [];
        // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let tournamentRounds = [];
        // ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let currentPairings = [];
        // ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·
        let currentRound = 0;
        // é©æ­£ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
        let requiredRounds = 0;
        // æœ€çµ‚çµæœè¡¨ç¤ºãƒ•ãƒ©ã‚°
        let isFinalStandings = false;
        // ãƒªã‚»ãƒƒãƒˆã®ç¨®é¡
        let resetType = 'tournament';

        // UIè¦ç´ ã®å–å¾—
        const playerNameInput = document.getElementById('playerNameInput');
        const playerListDiv = document.getElementById('playerList');
        const pairingsDiv = document.getElementById('pairings');
        const standingsDiv = document.getElementById('standings');
        const startRoundBtn = document.getElementById('startRoundBtn');
        const resetBtn = document.getElementById('resetBtn');
        const currentRoundInfoDiv = document.getElementById('currentRoundInfo');
        const messageBox = document.getElementById('messageBox');
        const playerCountDiv = document.getElementById('playerCount');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const standingsHeader = document.getElementById('standingsHeader');
        const resetMessage = document.getElementById('resetMessage');

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); // 3ç§’å¾Œã«éè¡¨ç¤º
        }
        
        // ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showResetConfirmation() {
            resetType = event.target.textContent.includes('ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ') ? 'tournament' : 'full';
            if (resetType === 'tournament') {
                resetMessage.textContent = 'ç¾åœ¨ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚å‚åŠ è€…ãƒªã‚¹ãƒˆã¯ä¿æŒã•ã‚Œã¾ã™ã€‚';
            } else {
                resetMessage.textContent = 'å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå‚åŠ è€…ãƒªã‚¹ãƒˆã‚’å«ã‚€ï¼‰ãŒå¤±ã‚ã‚Œã¾ã™ã€‚';
            }
            confirmationModal.classList.remove('hidden');
        }

        // ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹é–¢æ•°
        function hideResetConfirmation() {
            confirmationModal.classList.add('hidden');
        }

        // è¤‡æ•°ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¸€åº¦ã«è¿½åŠ ã™ã‚‹é–¢æ•°
        function addPlayers() {
            const names = playerNameInput.value.trim().split('\n').map(name => name.trim()).filter(name => name !== '');
            if (names.length === 0) {
                showMessage('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const newPlayers = [];
            let duplicateCount = 0;

            names.forEach(name => {
                if (players.some(player => player.name === name)) {
                    duplicateCount++;
                } else {
                    newPlayers.push({
                        name: name,
                        score: 0,
                        opponents: [],
                        results: {}, // ç›´æ¥å¯¾æ±ºã®çµæœã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                        byes: 0,
                        gamesWon: 0, // å–å¾—ã‚²ãƒ¼ãƒ æ•°
                        gamesLost: 0, // å¤±ã£ãŸã‚²ãƒ¼ãƒ æ•°
                        gamesDifference: 0, // å¾—å¤±ç‚¹å·®
                        wins: 0, // å‹åˆ©æ•°
                        losses: 0, // æ•—åŒ—æ•°
                    });
                }
            });

            if (newPlayers.length > 0) {
                players.push(...newPlayers);
                players.sort((a, b) => a.name.localeCompare(b.name));
                playerNameInput.value = '';
                renderPlayerList();
                renderStandings();
                calculateRequiredRounds();
                let message = `${newPlayers.length}äººã®å‚åŠ è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount}å€‹ã®é‡è¤‡ã—ãŸåå‰ã¯ç„¡è¦–ã•ã‚Œã¾ã—ãŸã€‚)`;
                }
                showMessage(message);
            } else {
                showMessage('æœ‰åŠ¹ãªå‚åŠ è€…ãŒã„ã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }
        
        // å‚åŠ è€…ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function removePlayer(index) {
            if (currentRound > 0) {
                showMessage('ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆé–‹å§‹å¾Œã¯å‚åŠ è€…ã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            const removedPlayerName = players[index].name;
            players.splice(index, 1);
            renderPlayerList();
            renderStandings();
            calculateRequiredRounds();
            showMessage(`${removedPlayerName}ã‚’å‚åŠ è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        }
        
        // å‚åŠ äººæ•°ã‹ã‚‰é©æ­£ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateRequiredRounds() {
            const n = players.length;
            if (n <= 1) {
                requiredRounds = 0;
            } else {
                // 2^r >= n ã¨ãªã‚‹æœ€å°ã®rã‚’æ±‚ã‚ã‚‹
                requiredRounds = Math.ceil(Math.log2(n));
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderPlayerList() {
            playerListDiv.innerHTML = players.map((player, index) => {
                return `
                    <div class="flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                        <span class="mr-2">${player.name}</span>
                        <button onclick="removePlayer(${index})" class="text-red-500 hover:text-red-700 font-bold ml-auto leading-none">&times;</button>
                    </div>`;
            }).join('');
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã®è¡¨ç¤ºã‚’æ›´æ–°
            playerCountDiv.textContent = `ç¾åœ¨ ${players.length} äººãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
        }

        // ã‚¹ã‚¤ã‚¹ãƒ‰ãƒ­ãƒ¼ã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function createPairings() {
            let unpairedPlayers;
            
            // ãƒ©ã‚¦ãƒ³ãƒ‰1ã¯å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªãƒšã‚¢ãƒªãƒ³ã‚°
            if (currentRound === 0) {
                unpairedPlayers = [...players].sort(() => Math.random() - 0.5);
            } else {
                // ãƒ©ã‚¦ãƒ³ãƒ‰2ä»¥é™ã¯ã‚¹ã‚³ã‚¢ã€å¾—å¤±ç‚¹å·®ã€æœ€å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚½ãƒ¼ãƒˆ
                unpairedPlayers = [...players].sort((a, b) => {
                    // 1. å‹åˆ©æ•°ã§æ¯”è¼ƒ
                    if (b.score !== a.score) return b.score - a.score;
                    
                    // 2. å¾—å¤±ç‚¹å·®ã§æ¯”è¼ƒ
                    const aGamesDiff = a.gamesWon - a.gamesLost;
                    const bGamesDiff = b.gamesWon - b.gamesLost;
                    if (bGamesDiff !== aGamesDiff) return bGamesDiff - aGamesDiff;
                    
                    // 3. å…¨ã¦ãŒåŒã˜å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚½ãƒ¼ãƒˆ
                    return Math.random() - 0.5;
                });
            }

            const pairings = [];
            
            // å‚åŠ è€…æ•°ãŒå¥‡æ•°ã®å ´åˆã€Byeï¼ˆä¸æˆ¦å‹ï¼‰ã‚’æ±ºå®š
            if (unpairedPlayers.length % 2 !== 0) {
                // Byeã¯ã€æœ€ã‚‚ã‚¹ã‚³ã‚¢ãŒä½ãã€ã¾ã Byeã‚’å—ã‘ã¦ã„ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ä¸ãˆã‚‹
                const byePlayer = unpairedPlayers
                    .filter(p => p.byes === 0)
                    .sort((a, b) => a.score - b.score)
                    .shift() || unpairedPlayers.pop(); // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€å¾Œã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼

                // Byeã®ãƒšã‚¢ãƒªãƒ³ã‚°ã«ã‚‚ games ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
                pairings.push({ player1: byePlayer.name, player2: 'Bye', result: 'player1', games: { p1: 0, p2: 0 }, isConfirmed: false });
                // byePlayerã‚’æœªãƒšã‚¢ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                const byeIndex = unpairedPlayers.findIndex(p => p.name === byePlayer.name);
                if(byeIndex !== -1) {
                    unpairedPlayers.splice(byeIndex, 1);
                }
            }
            
            // ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’ä½œæˆ
            while (unpairedPlayers.length > 0) {
                const player1 = unpairedPlayers.shift();
                let opponentFound = false;

                // ã‚¹ã‚³ã‚¢ã®è¿‘ã„é †ã«ç›¸æ‰‹ã‚’æ¢ã™
                for (let i = 0; i < unpairedPlayers.length; i++) {
                    const player2 = unpairedPlayers[i];
                    // å¯¾æˆ¦å±¥æ­´ãŒãªã„ã‹ç¢ºèª
                    if (!player1.opponents.includes(player2.name)) {
                        pairings.push({ player1: player1.name, player2: player2.name, result: null, games: { p1: 0, p2: 0 }, isConfirmed: false });
                        unpairedPlayers.splice(i, 1);
                        opponentFound = true;
                        break;
                    }
                }

                // é©åˆ‡ãªç›¸æ‰‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€å†å¯¾æˆ¦ã‚’è¨±å®¹ã™ã‚‹
                if (!opponentFound) {
                    const player2 = unpairedPlayers.shift();
                    pairings.push({ player1: player1.name, player2: player2.name, result: null, games: { p1: 0, p2: 0 }, isConfirmed: false });
                }
            }

            return pairings;
        }

        // ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderPairings() {
            pairingsDiv.innerHTML = '';
            currentPairings.forEach((pairing, index) => {
                const pairingDiv = document.createElement('div');
                
                // çµæœãŒç¢ºå®šã—ã¦ã„ã‚‹å ´åˆã¯ç·‘ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’è¿½åŠ 
                let cardClass = 'bg-white p-4 rounded-md shadow-sm border border-gray-200';
                if (pairing.isConfirmed) {
                    cardClass = 'bg-white p-4 rounded-md shadow-sm border-2 border-green-500';
                }
                pairingDiv.className = cardClass;
                
                const player1NameClass = (pairing.result === 'player1') ? 'text-green-600 font-bold' : 'text-gray-800 font-medium';
                const player2NameClass = (pairing.result === 'player2') ? 'text-green-600 font-bold' : 'text-gray-800 font-medium';
                
                const player2Name = pairing.player2 === 'Bye' ? 'Bye' : pairing.player2;
                const vsText = player2Name === 'Bye' ? '' : 'vs';

                let pairingContent = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg ${player1NameClass}">${pairing.player1}</span> ${vsText} <span class="text-lg ${player2NameClass}">${player2Name}</span>
                    </div>`;

                if (!pairing.isConfirmed) {
                    pairingContent += `
                        <div class="flex justify-center items-center gap-4 mt-2">
                            <div class="flex items-center gap-2">
                                <button onclick="changeScore(${index}, 1, -1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition duration-200">-</button>
                                <span id="p1-score-${index}" class="text-xl font-bold w-6 text-center">${pairing.games.p1}</span>
                                <button onclick="changeScore(${index}, 1, 1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition duration-200">+</button>
                            </div>
                            <span class="text-xl font-bold">:</span>
                            <div class="flex items-center gap-2">
                                <button onclick="changeScore(${index}, 2, -1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition duration-200">-</button>
                                <span id="p2-score-${index}" class="text-xl font-bold w-6 text-center">${pairing.games.p2}</span>
                                <button onclick="changeScore(${index}, 2, 1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition duration-200">+</button>
                            </div>
                        </div>
                        <div class="flex justify-center mt-4">
                            <button onclick="submitGameScore(${index})" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200">ç¢ºå®š</button>
                        </div>
                    `;
                } else {
                    let resultText = '';
                    if (pairing.result === 'player1') {
                        resultText = `${pairing.player1}ã®å‹åˆ©`;
                    } else if (pairing.result === 'player2') {
                        resultText = `${pairing.player2}ã®å‹åˆ©`;
                    } else if (pairing.result === 'draw') {
                        resultText = 'å¼•ãåˆ†ã‘';
                    }
                    pairingContent += `
                        <div class="mt-2 text-center text-sm font-semibold text-gray-700">${resultText}</div>
                        <div class="mt-1 text-center text-xs text-gray-500">ã‚²ãƒ¼ãƒ ã‚¹ã‚³ã‚¢: ${pairing.games.p1} - ${pairing.games.p2}</div>
                        <div class="flex justify-center mt-4">
                            <button onclick="revertGameScore(${index})" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-200">ç¢ºå®šè§£é™¤</button>
                        </div>
                    `;
                }
                
                if (player2Name === 'Bye') {
                    pairingContent = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg ${player1NameClass}">${pairing.player1}</span> <span class="text-lg text-gray-800 font-medium">Bye</span>
                        </div>
                        <div class="mt-2 text-center text-sm font-semibold text-gray-700">ä¸æˆ¦å‹</div>
                    `;
                }

                pairingDiv.innerHTML = pairingContent;
                pairingsDiv.appendChild(pairingDiv);
            });
        }
        
        // ã‚¹ã‚³ã‚¢ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
        function changeScore(pairingIndex, playerNum, delta) {
            const pairing = currentPairings[pairingIndex];
            if (playerNum === 1) {
                pairing.games.p1 = Math.max(0, pairing.games.p1 + delta);
            } else {
                pairing.games.p2 = Math.max(0, pairing.games.p2 + delta);
            }
            document.getElementById(`p1-score-${pairingIndex}`).textContent = pairing.games.p1;
            document.getElementById(`p2-score-${pairingIndex}`).textContent = pairing.games.p2;
        }

        // ã‚²ãƒ¼ãƒ ã‚¹ã‚³ã‚¢ã‚’ç¢ºå®šã™ã‚‹é–¢æ•°
        function submitGameScore(pairingIndex) {
            const pairing = currentPairings[pairingIndex];
            
            // å‹æ•—ã‚’åˆ¤å®š
            if (pairing.games.p1 > pairing.games.p2) {
                pairing.result = 'player1';
            } else if (pairing.games.p2 > pairing.games.p1) {
                pairing.result = 'player2';
            } else {
                pairing.result = 'draw'; // å¼•ãåˆ†ã‘
            }

            pairing.isConfirmed = true;
            
            renderPairings();
            
            // å…¨ã¦ã®çµæœãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ã€Œæ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const allResultsEntered = currentPairings.every(p => p.isConfirmed || p.player2 === 'Bye');
            if (allResultsEntered) {
                nextRoundBtn.style.display = 'block';
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ãŒè©¦åˆã‚’çµ‚ãˆã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
                // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€ã‹ã€æœ€çµ‚çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‹ã‚’åˆ¤æ–­
                const playersToPlayNextRound = players.filter(p => p.opponents.length < requiredRounds);
                
                if (playersToPlayNextRound.length <= 1) {
                    nextRoundBtn.textContent = 'æœ€çµ‚çµæœ';
                } else {
                    nextRoundBtn.textContent = 'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€';
                }
            } else {
                nextRoundBtn.style.display = 'none';
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚¹ã‚³ã‚¢ã‚’å…ƒã«æˆ»ã™é–¢æ•°
        function revertGameScore(pairingIndex) {
            const pairing = currentPairings[pairingIndex];
            pairing.isConfirmed = false;
            pairing.result = null;
            renderPairings();
            nextRoundBtn.style.display = 'none';
            showMessage('è©¦åˆçµæœã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
        }
        
        // é †ä½ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderStandings() {
            // é †ä½ä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯
            players.sort((a, b) => {
                // 1. å‹åˆ©æ•°ã§æ¯”è¼ƒ
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                
                // 2. å¾—å¤±ç‚¹å·®ã§æ¯”è¼ƒ
                const aGamesDiff = a.gamesWon - a.gamesLost;
                const bGamesDiff = b.gamesWon - b.gamesLost;
                if (bGamesDiff !== aGamesDiff) {
                    return bGamesDiff - aGamesDiff;
                }

                // 3. ç›´æ¥å¯¾æ±ºã®å‹æ•—ã§æ¯”è¼ƒ
                const aResultAgainstB = a.results[b.name];
                const bResultAgainstA = b.results[a.name];
                
                if (aResultAgainstB !== undefined || bResultAgainstA !== undefined) {
                    if (aResultAgainstB === 'win') {
                        return -1; // AãŒBã«å‹ã£ã¦ã„ã‚Œã°AãŒä¸Šä½
                    }
                    if (bResultAgainstA === 'win') {
                        return 1; // BãŒAã«å‹ã£ã¦ã„ã‚Œã°BãŒä¸Šä½
                    }
                }
                
                // 4. å…¨ã¦ãŒåŒã˜å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚½ãƒ¼ãƒˆ
                return Math.random() - 0.5;
            });
            
            standingsDiv.innerHTML = `
                <div class="flex font-semibold text-gray-700 border-b-2 border-gray-300 pb-2">
                    <span class="w-1/6">é †ä½</span>
                    <span class="w-2/6">åå‰</span>
                    <span class="w-1/6 text-center">å‹åˆ©æ•°</span>
                    <span class="w-1/6 text-center">æ•—åŒ—æ•°</span>
                    <span class="w-1/6 text-center">å¾—ç‚¹</span>
                    <span class="w-1/6 text-center">å¤±ç‚¹</span>
                    <span class="w-1/6 text-center">å¾—å¤±ç‚¹å·®</span>
                </div>
            `;

            players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center text-gray-800 py-2 border-b border-gray-200';
                
                const gamesDifference = player.gamesWon - player.gamesLost;
                
                let rankDisplay = index + 1;
                let playerNameWithMedal = player.name;

                // æœ€çµ‚çµæœè¡¨ç¤ºæ™‚ã®ã¿ãƒ¡ãƒ€ãƒ«ã‚’è¡¨ç¤º
                if (isFinalStandings && index < 3) {
                    if (index === 0) {
                        playerNameWithMedal = `ğŸ‘‘ ${player.name}`;
                    } else if (index === 1) {
                        playerNameWithMedal = `ğŸ¥ˆ ${player.name}`;
                    } else if (index === 2) {
                        playerNameWithMedal = `ğŸ¥‰ ${player.name}`;
                    }
                }

                playerDiv.innerHTML = `
                    <span class="w-1/6 font-bold text-lg text-gray-600">${rankDisplay}</span>
                    <span class="w-2/6">${playerNameWithMedal}</span>
                    <span class="w-1/6 font-semibold text-center">${player.wins}</span>
                    <span class="w-1/6 font-semibold text-center">${player.losses}</span>
                    <span class="w-1/6 text-sm text-center">${player.gamesWon}</span>
                    <span class="w-1/6 text-sm text-center">${player.gamesLost}</span>
                    <span class="w-1/6 text-sm text-center">${gamesDifference}</span>
                `;
                standingsDiv.appendChild(playerDiv);
            });
        }
        
        // æœ€çµ‚çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showFinalStandings() {
            isFinalStandings = true;
            renderStandings(); // è±ªè¯ãªé †ä½è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            pairingsDiv.innerHTML = ''; // ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢
            
            // ä¸Šä½3åã®æƒ…å ±ã‚’å–å¾—
            const topPlayers = players.slice(0, 3);
            const topPlayerNamesHtml = topPlayers.map((p, index) => {
                if (index === 0) return `<div class="text-3xl font-bold text-gray-800">ğŸ‘‘ ${p.name}</div>`;
                if (index === 1) return `<div class="text-2xl font-semibold text-gray-700">ğŸ¥ˆ ${p.name}</div>`;
                if (index === 2) return `<div class="text-xl font-medium text-gray-600">ğŸ¥‰ ${p.name}</div>`;
            }).join('');

            currentRoundInfoDiv.innerHTML = `
                <div class="text-center text-4xl font-bold text-green-700 mb-4">æœ€çµ‚çµæœ</div>
                <div class="flex flex-col items-center space-y-4">${topPlayerNamesHtml}</div>
            `;
            
            standingsHeader.textContent = 'æœ€çµ‚é †ä½';
            standingsHeader.classList.add('text-center', 'text-2xl', 'font-bold', 'text-green-700');
            nextRoundBtn.style.display = 'none';
            showMessage('ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸï¼');
        }

        // æ–°ã—ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startNewRound() {
            if (players.length < 2) {
                showMessage('2äººä»¥ä¸Šã®å‚åŠ è€…ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            if (currentRound > 0) {
                 showMessage('ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®çµæœã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ã‹ã‚‰ã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                 return;
            }
            
            isFinalStandings = false;
            currentRound++;
            currentPairings = createPairings();

            currentRoundInfoDiv.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${currentRound} (æ¨å¥¨ãƒ©ã‚¦ãƒ³ãƒ‰æ•°: ${requiredRounds})`;
            renderPairings();
            startRoundBtn.style.display = 'none';
            showMessage(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${currentRound} ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚`);
        }

        // ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’çµ‚äº†ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€é–¢æ•°
        function proceedToNextStep() {
            // ã‚¹ã‚³ã‚¢ã¨ã‚²ãƒ¼ãƒ æ•°ã‚’æ›´æ–°
            currentPairings.forEach(pairing => {
                const player1 = players.find(p => p.name === pairing.player1);
                const player2 = players.find(p => p.name === pairing.player2);
                
                // player1ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                if (!player1) {
                    console.error("Player1 not found for pairing:", pairing);
                    return;
                }

                // Byeã®å ´åˆã¯player2ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€player1ã®ä¸æˆ¦å‹ã‚’è¨˜éŒ²
                if (pairing.player2 === 'Bye') {
                    player1.score += 1;
                    player1.byes++;
                    return; // æ¬¡ã®ãƒšã‚¢ãƒªãƒ³ã‚°ã¸
                }

                // ã“ã“ã«æ¥ã‚‹ã®ã¯Byeã§ã¯ãªã„é€šå¸¸ã®å¯¾æˆ¦
                if (!player2) {
                    console.error("Player2 not found for pairing (should not happen for non-Bye):", pairing);
                    return;
                }

                // å‹æ•—ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢æ›´æ–°
                if (pairing.result === 'player1') {
                    player1.score += 1;
                    player1.wins++;
                    player2.losses++;
                    player1.results[player2.name] = 'win';
                    player2.results[player1.name] = 'lose';
                } else if (pairing.result === 'player2') {
                    player2.score += 1;
                    player2.wins++;
                    player1.losses++;
                    player2.results[player1.name] = 'win';
                    player1.results[player2.name] = 'lose';
                } else if (pairing.result === 'draw') {
                    player1.score += 0.5;
                    player2.score += 0.5;
                    player1.results[player2.name] = 'draw';
                    player2.results[p1.name] = 'draw';
                }
                
                // ã‚²ãƒ¼ãƒ æ•°ã‚’è¨˜éŒ²
                player1.gamesWon += pairing.games.p1;
                player1.gamesLost += pairing.games.p2;
                player1.gamesDifference += (pairing.games.p1 - pairing.games.p2);

                player2.gamesWon += pairing.games.p2;
                player2.gamesLost += pairing.games.p1;
                player2.gamesDifference += (pairing.games.p2 - pairing.games.p1);

                // å¯¾æˆ¦ç›¸æ‰‹ã‚’è¨˜éŒ²
                player1.opponents.push(player2.name);
                player2.opponents.push(player1.name);
            });

            tournamentRounds.push({ round: currentRound, pairings: currentPairings });
            renderStandings();

            // æ¨å¥¨ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã«é”ã—ã¦ã„ã‚‹ã‹ã€ã¾ãŸã¯æœªæ¶ˆåŒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1äººä»¥ä¸‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
            const playersToPlayNextRound = players.filter(p => p.opponents.length < requiredRounds);

            // æ¨å¥¨ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã«é”ã—ãŸã‹ã€æœªæ¶ˆåŒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1äººä»¥ä¸‹ãªã‚‰çµ‚äº†
            if (currentRound >= requiredRounds && playersToPlayNextRound.length <= 1) {
                showFinalStandings();
            } else {
                // æ–°ã—ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹
                currentRound++;
                currentPairings = createPairings();
                pairingsDiv.innerHTML = '';
                currentRoundInfoDiv.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${currentRound} (æ¨å¥¨ãƒ©ã‚¦ãƒ³ãƒ‰æ•°: ${requiredRounds})`;
                renderPairings();
                nextRoundBtn.style.display = 'none';
                showMessage(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${currentRound} ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚`);
            }
        }
        
        // ã‚¢ãƒ—ãƒªã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•° (å…¨ãƒªã‚»ãƒƒãƒˆ)
        function resetApp() {
            players = [];
            playerNameInput.value = '';
            resetTournament();
            showMessage('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
        }
        
        // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•° (å‚åŠ è€…ãƒªã‚¹ãƒˆã¯ä¿æŒ)
        function resetTournament() {
            players.forEach(player => {
                player.score = 0;
                player.opponents = [];
                player.results = {};
                player.byes = 0;
                player.gamesWon = 0;
                player.gamesLost = 0;
                player.gamesDifference = 0;
                player.wins = 0;
                player.losses = 0;
            });

            tournamentRounds = [];
            currentPairings = [];
            currentRound = 0;
            isFinalStandings = false;
            
            renderPlayerList();
            renderStandings();
            pairingsDiv.innerHTML = '';
            currentRoundInfoDiv.textContent = 'ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
            startRoundBtn.style.display = 'block';
            nextRoundBtn.style.display = 'none';
            standingsHeader.textContent = 'é †ä½';
            standingsHeader.classList.remove('text-center', 'text-2xl', 'font-bold', 'text-green-700');
            
            showMessage('ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            hideResetConfirmation();
        }

        // åˆæœŸè¡¨ç¤º
        renderStandings();
        renderPlayerList();

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        confirmResetBtn.addEventListener('click', () => {
            if (resetType === 'full') {
                resetApp();
            } else {
                resetTournament();
            }
        });
        cancelResetBtn.addEventListener('click', hideResetConfirmation);
    </script>
</body>
</html>
